<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Change Request Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #2563b5;
            box-shadow: 0 0 0 3px rgba(37, 99, 181, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 44px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .toggle-note {
            font-size: 13px;
            color: #666;
            font-style: italic;
            transition: opacity 0.3s;
        }

        .toggle-note.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .toggle-switch {
            position: relative;
            width: 140px;
            height: 36px;
            background: #e0e0e0;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 68px;
            height: 30px;
            background: #2563b5;
            border-radius: 15px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.update .toggle-slider {
            left: 69px;
        }

        .toggle-labels {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .toggle-label {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            transition: color 0.3s;
            z-index: 1;
            color: #666;
        }

        .toggle-switch:not(.update) .toggle-label:first-child,
        .toggle-switch.update .toggle-label:last-child {
            color: white;
        }

        .field-input {
            transition: all 0.3s ease;
        }

        .field-input.hidden {
            display: none;
        }

        .labor-section {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .labor-section .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .items-section {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .items-section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .item-row {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .change-type {
            margin-bottom: 15px;
        }

        .change-type-selection {
            margin-bottom: 20px;
        }

        .change-type-prompt {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .change-type-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-change-type {
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 180px;
        }

        .btn-change-type[data-change="adding this item"] {
            background: #28a745;
        }

        .btn-change-type[data-change="adding this item"]:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-change-type[data-change="removing this item"] {
            background: #dc5959;
        }

        .btn-change-type[data-change="removing this item"]:hover {
            background: #c24545;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 89, 89, 0.3);
        }

        .btn-change-type[data-change="updating quantity"] {
            background: #f0ad4e;
        }

        .btn-change-type[data-change="updating quantity"]:hover {
            background: #ec971f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(240, 173, 78, 0.3);
        }

        .change-type-display {
            background-color: #f5f5f5 !important;
            cursor: not-allowed;
        }

        .change-type-display.adding {
            color: #28a745;
            font-weight: 600;
        }

        .change-type-display.removing {
            color: #dc5959;
            font-weight: 600;
        }

        .change-type-display.updating {
            color: #f0ad4e;
            font-weight: 600;
        }

        .change-type.invalid {
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .btn-add-item {
            background: #2563b5;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add-item:hover {
            background: #1e4f94;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 181, 0.3);
        }

        .btn-add-item::before {
            content: '+';
            font-size: 20px;
            font-weight: bold;
        }

        .btn-remove-item {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc5959;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .btn-remove-item:hover {
            background: #c24545;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(220, 89, 89, 0.4);
        }

        .btn-remove-item::before {
            content: 'Ã—';
            font-size: 20px;
        }

        .submit-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-submit,
        .btn-cancel {
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit {
            background: #2563b5;
            color: white;
        }

        .btn-submit:hover {
            background: #1e4f94;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 181, 0.4);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .note {
            font-size: 12px;
            color: #888;
            font-style: italic;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            .labor-section {
                flex-direction: column;
            }

            .item-row-header {
                flex-direction: column;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BOM Change Request Form</h1>
        
        <form id="bomForm" novalidate>
            <div class="form-group">
                <label for="submitter">Submitter</label>
                <input type="text" id="submitter" placeholder="Enter your first and last name">
            </div>

            <div class="form-group">
                <label for="bomItem">BOM Item #</label>
                <input type="text" id="bomItem" placeholder="Enter the item number of the BOM you're modifying">
            </div>

            <div class="form-group">
                <label for="searchName">Search Name</label>
                <div class="toggle-container">
                    <div class="toggle-switch" data-field="searchName">
                        <div class="toggle-slider"></div>
                        <div class="toggle-labels">
                            <span class="toggle-label">Keep</span>
                            <span class="toggle-label">Update</span>
                        </div>
                    </div>
                    <span class="toggle-note" data-note="searchName">The Search Name will stay the same, select update to make a change.</span>
                </div>
                <input type="text" id="searchName" class="field-input hidden" placeholder="Enter updated search name">
            </div>

            <div class="form-group">
                <label for="internalDesc">Internal Description</label>
                <div class="toggle-container">
                    <div class="toggle-switch" data-field="internalDesc">
                        <div class="toggle-slider"></div>
                        <div class="toggle-labels">
                            <span class="toggle-label">Keep</span>
                            <span class="toggle-label">Update</span>
                        </div>
                    </div>
                    <span class="toggle-note" data-note="internalDesc">The Internal Description will stay the same, select update to make a change.</span>
                </div>
                <textarea id="internalDesc" class="field-input hidden" placeholder="Enter updated internal description"></textarea>
            </div>

            <div class="form-group">
                <label for="externalDesc">External Description</label>
                <div class="toggle-container">
                    <div class="toggle-switch" data-field="externalDesc">
                        <div class="toggle-slider"></div>
                        <div class="toggle-labels">
                            <span class="toggle-label">Keep</span>
                            <span class="toggle-label">Update</span>
                        </div>
                    </div>
                    <span class="toggle-note" data-note="externalDesc">The External Description will stay the same, select update to make a change.</span>
                </div>
                <textarea id="externalDesc" class="field-input hidden" placeholder="Enter updated external description"></textarea>
            </div>

            <div class="form-group">
                <label for="routeNotes">Route Note</label>
                <div class="toggle-container">
                    <div class="toggle-switch" data-field="routeNotes">
                        <div class="toggle-slider"></div>
                        <div class="toggle-labels">
                            <span class="toggle-label">Keep</span>
                            <span class="toggle-label">Update</span>
                        </div>
                    </div>
                    <span class="toggle-note" data-note="routeNotes">The Route Note will stay the same, select update to make a change.</span>
                </div>
                <textarea id="routeNotes" class="field-input hidden" placeholder="Enter updated route note"></textarea>
            </div>

            <div class="form-group">
                <label for="laborTime">Labor Time</label>
                <div class="toggle-container">
                    <div class="toggle-switch" data-field="laborTime">
                        <div class="toggle-slider"></div>
                        <div class="toggle-labels">
                            <span class="toggle-label">Keep</span>
                            <span class="toggle-label">Update</span>
                        </div>
                    </div>
                    <span class="toggle-note" data-note="laborTime">The Labor Time will stay the same, select update to make a change.</span>
                </div>
                <div id="laborTime" class="labor-section field-input hidden">
                    <div class="form-group">
                        <label for="laborAssembly">Assembly Time</label>
                        <input type="text" id="laborAssembly" placeholder="Enter updated assembly time in minutes">
                    </div>
                    <div class="form-group">
                        <label for="laborTesting">Test Time</label>
                        <input type="text" id="laborTesting" placeholder="Enter updated test time in minutes">
                    </div>
                </div>
            </div>

            <div class="items-section">
                <h2>BOM Line Items</h2>
                <div id="emptyState" class="empty-state">
                    Click "Add Item" below to add, remove, or change qty of BOM line items
                </div>
                <div id="itemsContainer">
                    <!-- Items will be added here dynamically -->
                </div>
                <button type="button" class="btn-add-item" id="addItemBtn">Add Item</button>
            </div>

            <div class="submit-section">
                <button type="submit" class="btn-submit">Submit Request</button>
                <button type="button" class="btn-cancel">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        let itemCounter = 0;

        // Handle toggle switches
        document.querySelectorAll('.toggle-switch').forEach(toggle => {
            toggle.addEventListener('click', function() {
                this.classList.toggle('update');
                const fieldId = this.getAttribute('data-field');
                const field = document.getElementById(fieldId);
                const note = document.querySelector(`[data-note="${fieldId}"]`);
                
                if (this.classList.contains('update')) {
                    field.classList.remove('hidden');
                    if (note) note.classList.add('hidden');
                    
                    // Focus on appropriate field
                    if (fieldId === 'laborTime') {
                        // Focus on assembly time field for labor time
                        setTimeout(() => {
                            document.getElementById('laborAssembly').focus();
                        }, 100);
                    } else {
                        field.focus();
                    }
                } else {
                    field.classList.add('hidden');
                    if (note) note.classList.remove('hidden');
                    field.value = '';
                }
            });
        });

        // Auto-expand textareas
        function autoExpandTextarea(textarea) {
            textarea.style.height = '44px';
            const scrollHeight = textarea.scrollHeight;
            textarea.style.height = Math.min(scrollHeight, 200) + 'px';
        }

        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', function() {
                autoExpandTextarea(this);
            });
        });

        function createItemRow() {
            itemCounter++;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.innerHTML = `
                <button type="button" class="btn-remove-item" title="Remove item from request"></button>
                
                <div class="change-type-selection">
                    <div class="change-type-prompt">Select the change needed for this BOM line item</div>
                    <div class="change-type-buttons">
                        <button type="button" class="btn-change-type" data-change="adding this item" data-color="adding">Add new item to BOM</button>
                        <button type="button" class="btn-change-type" data-change="removing this item" data-color="removing">Remove item from BOM</button>
                        <button type="button" class="btn-change-type" data-change="updating quantity" data-color="updating">Update qty of existing item</button>
                    </div>
                </div>
                
                <div class="item-fields" style="display: none;">
                    <div class="labor-section">
                        <div class="form-group">
                            <label>Item #</label>
                            <input type="text" class="item-number-input" placeholder="Enter item #" />
                        </div>
                        <div class="form-group">
                            <label>Qty</label>
                            <input type="text" class="qty-input" placeholder="Enter quantity" />
                        </div>
                        <div class="form-group">
                            <label>Change Type</label>
                            <input type="text" class="change-type-display" readonly />
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners to change type buttons
            const changeTypeBtns = itemDiv.querySelectorAll('.btn-change-type');
            const changeTypeSelection = itemDiv.querySelector('.change-type-selection');
            const itemFields = itemDiv.querySelector('.item-fields');
            const changeTypeDisplay = itemDiv.querySelector('.change-type-display');
            const qtyInput = itemDiv.querySelector('.qty-input');
            
            changeTypeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const changeType = this.getAttribute('data-change');
                    const colorClass = this.getAttribute('data-color');
                    
                    changeTypeDisplay.value = changeType;
                    changeTypeDisplay.className = 'change-type-display ' + colorClass;
                    
                    // Update qty field based on change type
                    if (changeType === 'removing this item') {
                        qtyInput.value = 'All';
                        qtyInput.placeholder = 'All';
                        qtyInput.readOnly = true;
                        qtyInput.style.cursor = 'not-allowed';
                        qtyInput.style.backgroundColor = '#f5f5f5';
                    } else if (changeType === 'updating quantity') {
                        qtyInput.placeholder = 'Enter updated qty';
                        qtyInput.readOnly = false;
                        qtyInput.style.cursor = 'text';
                        qtyInput.style.backgroundColor = 'white';
                    } else {
                        qtyInput.placeholder = 'Enter quantity';
                        qtyInput.readOnly = false;
                        qtyInput.style.cursor = 'text';
                        qtyInput.style.backgroundColor = 'white';
                    }
                    
                    changeTypeSelection.style.display = 'none';
                    itemFields.style.display = 'block';
                    
                    // Focus on item # field after selecting change type
                    const itemNumberInput = itemDiv.querySelector('.item-number-input');
                    setTimeout(() => {
                        itemNumberInput.focus();
                    }, 100);
                });
            });
            
            // Add event listener to remove button
            const removeBtn = itemDiv.querySelector('.btn-remove-item');
            removeBtn.addEventListener('click', function() {
                itemDiv.remove();
                
                // Show empty state if no items remain
                const container = document.getElementById('itemsContainer');
                const emptyState = document.getElementById('emptyState');
                if (container.children.length === 0 && emptyState) {
                    emptyState.style.display = 'block';
                }
            });
            
            return itemDiv;
        }

        document.getElementById('addItemBtn').addEventListener('click', function() {
            const container = document.getElementById('itemsContainer');
            const emptyState = document.getElementById('emptyState');
            
            // Hide empty state when first item is added
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            container.appendChild(createItemRow());
        });

        document.getElementById('bomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Check if all items have a change type selected
            const items = document.querySelectorAll('.item-row');
            let allValid = true;
            let errorMessages = [];
            
            items.forEach((item, index) => {
                const changeTypeSelection = item.querySelector('.change-type-selection');
                const itemNumberInput = item.querySelector('.item-number-input');
                const qtyInput = item.querySelector('.qty-input');
                const changeTypeDisplay = item.querySelector('.change-type-display');
                
                // If change type selection is still visible, user hasn't selected a change type
                if (changeTypeSelection && changeTypeSelection.style.display !== 'none') {
                    allValid = false;
                    changeTypeSelection.style.border = '2px solid #dc5959';
                    changeTypeSelection.style.padding = '10px';
                    changeTypeSelection.style.borderRadius = '8px';
                    
                    setTimeout(() => {
                        changeTypeSelection.style.border = '';
                        changeTypeSelection.style.padding = '';
                    }, 2000);
                    errorMessages.push('Please select a change type for item ' + (index + 1));
                }
                
                // Check if item number is filled
                if (itemNumberInput && itemNumberInput.value.trim() === '') {
                    allValid = false;
                    itemNumberInput.style.borderColor = '#dc5959';
                    setTimeout(() => {
                        itemNumberInput.style.borderColor = '';
                    }, 2000);
                    errorMessages.push('Please enter an Item # for item ' + (index + 1));
                }
                
                // Check if qty is filled (but only if not "removing this item" since that's auto-populated)
                if (qtyInput && changeTypeDisplay && changeTypeDisplay.value !== 'removing this item') {
                    if (qtyInput.value.trim() === '') {
                        allValid = false;
                        qtyInput.style.borderColor = '#dc5959';
                        setTimeout(() => {
                            qtyInput.style.borderColor = '';
                        }, 2000);
                        errorMessages.push('Please enter a Qty for item ' + (index + 1));
                    }
                }
            });
            
            if (!allValid) {
                alert(errorMessages.join('\n'));
                return;
            }
            
            // Generate CSV
            const csvData = [];
            
            // Add header row
            csvData.push(['BOM Change Request Form']);
            csvData.push(['Submitted', new Date().toLocaleString()]);
            csvData.push([]);
            
            // Add Submitter
            csvData.push(['Submitter', document.getElementById('submitter').value]);
            
            // Add BOM Item #
            csvData.push(['BOM Item #', document.getElementById('bomItem').value]);
            csvData.push([]);
            
            // Add Search Name
            const searchNameToggle = document.querySelector('[data-field="searchName"]');
            if (searchNameToggle && searchNameToggle.classList.contains('update')) {
                csvData.push(['Search Name', document.getElementById('searchName').value]);
            } else {
                csvData.push(['Search Name', 'No Change']);
            }
            
            // Add Internal Description
            const internalDescToggle = document.querySelector('[data-field="internalDesc"]');
            if (internalDescToggle && internalDescToggle.classList.contains('update')) {
                csvData.push(['Internal Description', document.getElementById('internalDesc').value]);
            } else {
                csvData.push(['Internal Description', 'No Change']);
            }
            
            // Add External Description
            const externalDescToggle = document.querySelector('[data-field="externalDesc"]');
            if (externalDescToggle && externalDescToggle.classList.contains('update')) {
                csvData.push(['External Description', document.getElementById('externalDesc').value]);
            } else {
                csvData.push(['External Description', 'No Change']);
            }
            
            // Add Route Note
            const routeNotesToggle = document.querySelector('[data-field="routeNotes"]');
            if (routeNotesToggle && routeNotesToggle.classList.contains('update')) {
                csvData.push(['Route Note', document.getElementById('routeNotes').value]);
            } else {
                csvData.push(['Route Note', 'No Change']);
            }
            
            // Add Labor Time
            const laborTimeToggle = document.querySelector('[data-field="laborTime"]');
            if (laborTimeToggle && laborTimeToggle.classList.contains('update')) {
                csvData.push(['Assembly Time', document.getElementById('laborAssembly').value]);
                csvData.push(['Test Time', document.getElementById('laborTesting').value]);
            } else {
                csvData.push(['Labor Time', 'No Change']);
            }
            
            csvData.push([]);
            csvData.push(['BOM Line Items']);
            csvData.push(['Item #', 'Qty', 'Change Type']);
            
            // Add all line items
            items.forEach((item, index) => {
                const itemNumber = item.querySelector('.item-number-input').value;
                const qty = item.querySelector('.qty-input').value;
                const changeType = item.querySelector('.change-type-display').value;
                csvData.push([itemNumber, qty, changeType]);
            });
            
            // Convert to CSV string
            const csvContent = csvData.map(row => 
                row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma, quote, or newline
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',')
            ).join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const bomItemNumber = document.getElementById('bomItem').value || 'BOM';
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `BOM_Change_Request_${bomItemNumber}_${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('BOM Change Request CSV has been downloaded!');
        });

        document.querySelector('.btn-cancel').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel? All changes will be lost.')) {
                document.getElementById('bomForm').reset();
                itemCounter = 0;
                document.getElementById('itemsContainer').innerHTML = '';
                
                // Show empty state
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                
                // Reset all toggles to "Keep"
                document.querySelectorAll('.toggle-switch').forEach(toggle => {
                    toggle.classList.remove('update');
                });
                document.querySelectorAll('.field-input').forEach(field => {
                    field.classList.add('hidden');
                });
                document.querySelectorAll('.toggle-note').forEach(note => {
                    note.classList.remove('hidden');
                });
            }
        });
    </script>
</body>
</html>
